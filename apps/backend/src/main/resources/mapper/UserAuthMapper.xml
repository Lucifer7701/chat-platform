<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<!-- UserAuthMapper.xml -->
<mapper namespace="com.dating.mapper.UserAuthMapper">

    <!-- 插入认证信息 -->
    <insert id="insert" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO user_auth (
            user_id, phone, password, login_type, third_party_id,
            login_count, status
        ) VALUES (
                     #{userId}, #{phone}, #{password}, #{loginType}, #{thirdPartyId},
                     #{loginCount}, #{status}
                 )
    </insert>

    <!-- 根据ID查询 -->
    <select id="findById" resultType="com.dating.entity.UserAuth">
        SELECT
            id, user_id, phone, password, login_type, third_party_id,
            last_login_time, login_ip, login_count, status, created_at, updated_at
        FROM user_auth
        WHERE id = #{id}
    </select>

    <!-- 根据手机号和登录类型查询认证信息 -->
    <select id="findByPhoneAndLoginType" resultType="com.dating.entity.UserAuth">
        SELECT
            id, user_id, phone, password, login_type, third_party_id,
            last_login_time, login_ip, login_count, status, created_at, updated_at
        FROM user_auth
        WHERE phone = #{phone} AND login_type = #{loginType} AND status = 1
    </select>

    <!-- 更新登录信息 -->
    <update id="updateLoginInfo">
        UPDATE user_auth
        SET last_login_time = #{loginTime},
            login_ip = #{loginIp},
            login_count = login_count + 1,
            updated_at = CURRENT_TIMESTAMP
        WHERE id = #{id}
    </update>

    <!-- 检查手机号是否已注册 -->
    <select id="countByPhone" resultType="int">
        SELECT COUNT(*)
        FROM user_auth
        WHERE phone = #{phone} AND login_type = 1 AND status = 1
    </select>

    <!-- 根据用户ID删除认证信息 -->
    <delete id="deleteByUserId">
        DELETE FROM user_auth WHERE user_id = #{userId}
    </delete>

    <!-- 更新密码 -->
    <update id="updatePassword">
        UPDATE user_auth
        SET password = #{password}, updated_at = CURRENT_TIMESTAMP
        WHERE id = #{id}
    </update>

    <!-- 根据用户ID查询认证信息 -->
    <select id="findByUserId" resultType="com.dating.entity.UserAuth">
        SELECT
            id, user_id, phone, password, login_type, third_party_id,
            last_login_time, login_ip, login_count, status, created_at, updated_at
        FROM user_auth
        WHERE user_id = #{userId} AND login_type = 1 AND status = 1
    </select>


</mapper>