<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.dating.mapper.SmsCodeMapper">

    <resultMap id="BaseResultMap" type="com.dating.entity.SmsCode">
        <id column="id" property="id"/>
        <result column="phone" property="phone"/>
        <result column="code" property="code"/>
        <result column="type" property="type"/>
        <result column="used" property="used"/>
        <result column="expire_time" property="expireTime"/>
        <result column="ip" property="ip"/>
        <result column="created_at" property="createdAt"/>
    </resultMap>

    <!-- 插入验证码 -->
    <insert id="insert" parameterType="com.dating.entity.SmsCode" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO sms_code(phone, code, type, used, expire_time, ip, created_at)
        VALUES(#{phone}, #{code}, #{type}, #{used}, #{expireTime}, #{ip}, NOW())
    </insert>

    <!-- 查询最新的有效验证码 -->
    <select id="findLatestValidCode" resultMap="BaseResultMap">
        SELECT * FROM sms_code
        WHERE phone = #{phone}
          AND type = #{type}
          AND used = 0
          AND expire_time > NOW()
        ORDER BY created_at DESC
            LIMIT 1
    </select>

    <!-- 标记验证码为已使用 -->
    <update id="markAsUsed">
        UPDATE sms_code
        SET used = 1
        WHERE id = #{id}
    </update>

    <!-- 清理过期验证码 -->
    <delete id="clearExpiredCodes">
         <![CDATA[
        DELETE FROM sms_code
        WHERE expire_time < NOW()
        ]]>
    </delete>

    <!-- 查询今日发送次数 -->
    <select id="countTodaySendTimes" resultType="int">
        SELECT COUNT(*)
        FROM sms_code
        WHERE phone = #{phone}
          AND DATE(created_at) = CURDATE()
    </select>

    <!-- 查询最近发送的验证码 -->
    <select id="findLatestByPhoneAndType" resultMap="BaseResultMap">
        SELECT * FROM sms_code
        WHERE phone = #{phone}
          AND type = #{type}
        ORDER BY created_at DESC
            LIMIT 1
    </select>

</mapper>